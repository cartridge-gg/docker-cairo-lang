name: "Build and push Docker Image"

on:
  workflow_dispatch:

jobs:
  build-amd64:
    name: "Build for linux/amd64"
    runs-on: "ubuntu-latest"

    env:
      DOCKER_REPOSITORY: "starknet/cairo-lang"

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v3"

      - name: "Login to GitHub container registry"
        uses: "docker/login-action@v2"
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Determine image version"
        run: |
          echo "VERSION=$(cat ./CAIRO_VERSION)" >> $GITHUB_ENV

      - name: "Build Docker image"
        run: |
          docker build --build-arg "CAIRO_VERSION=${VERSION}" -t ghcr.io/${{ github.repository }}:${VERSION} -t ghcr.io/${{ github.repository }}:latest -f ./Dockerfile .

      - name: "Push Docker image"
        run: |
          docker push ghcr.io/${{ github.repository }}:${VERSION}
          docker push ghcr.io/${{ github.repository }}:latest
